<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨ä¼°å€¼ç›‘æ§é¢æ¿</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto px-4 py-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold">è‚¡ç¥¨ä¼°å€¼ç›‘æ§</h1>
                        <p class="text-blue-100 mt-1">å®æ—¶è¿½è¸ªå¸‚åœºä¼°å€¼å˜åŒ–</p>
                        <div class="flex items-center mt-2">
                            <div class="flex items-center">
                                <div :class="supabaseClient ? 'bg-green-400' : 'bg-yellow-400'" class="w-2 h-2 rounded-full mr-2"></div>
                                <span class="text-xs text-blue-100">
                                    {{ supabaseClient ? 'ğŸ”— çœŸå®æ•°æ®' : 'ğŸ§ª æ¨¡æ‹Ÿæ•°æ®' }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-100">æœ€åæ›´æ–°</div>
                        <div class="font-semibold">{{ lastUpdateTime }}</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="container mx-auto px-4 py-6">
            <!-- æŸ¥è¯¢æ¡ä»¶åŒºåŸŸ -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">ğŸ“… æŸ¥è¯¢æ¡ä»¶</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- æ—¥æœŸé€‰æ‹© - å¿…é€‰ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ <span class="text-red-500">*</span>
                        </label>
                        <input 
                            v-model="selectedDate" 
                            type="date" 
                            :max="maxDate"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            required
                        >
                        <p class="text-xs text-gray-500 mt-1">è¯·é€‰æ‹©è¦æŸ¥è¯¢çš„æ•°æ®æ—¥æœŸ</p>
                    </div>

                    <!-- è‚¡ç¥¨é€‰æ‹© - å¯é€‰ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            é€‰æ‹©è‚¡ç¥¨ (å¯é€‰)
                        </label>
                        <div class="relative">
                            <select 
                                v-model="selectedStocks" 
                                multiple
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                size="3"
                            >
                                <option value="">å…¨éƒ¨è‚¡ç¥¨</option>
                                <option v-for="stock in availableStocks" :key="stock.code" :value="stock.code">
                                    {{ stock.code }} - {{ stock.name }}
                                </option>
                            </select>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">ä¸é€‰æ‹©åˆ™æ˜¾ç¤ºæ‰€æœ‰è‚¡ç¥¨ï¼ŒæŒ‰ä½Ctrlå¯å¤šé€‰</p>
                    </div>
                </div>

                <!-- å¿«æ·æ—¥æœŸé€‰æ‹© -->
                <div class="mt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">å¿«æ·é€‰æ‹©</label>
                    <div class="flex flex-wrap gap-2">
                        <button 
                            v-for="quickDate in quickDates" 
                            :key="quickDate.label"
                            @click="selectQuickDate(quickDate.date)"
                            class="px-3 py-1 text-sm bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors"
                        >
                            {{ quickDate.label }}
                        </button>
                    </div>
                </div>

                <!-- æŸ¥è¯¢æŒ‰é’® -->
                <div class="mt-6 flex justify-center">
                    <button 
                        @click="queryData" 
                        :disabled="!selectedDate || querying"
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors flex items-center"
                    >
                        <svg v-if="querying" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        {{ querying ? 'æŸ¥è¯¢ä¸­...' : 'æŸ¥è¯¢æ•°æ®' }}
                    </button>
                </div>
            </div>

            <!-- æŸ¥è¯¢æç¤º -->
            <div v-if="!hasQueried && !loading" class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6 text-center">
                <svg class="w-12 h-12 text-blue-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-blue-800 mb-2">è¯·é€‰æ‹©æŸ¥è¯¢æ—¥æœŸ</h3>
                <p class="text-blue-600">é€‰æ‹©æ—¥æœŸåç‚¹å‡»"æŸ¥è¯¢æ•°æ®"æŒ‰é’®è·å–è‚¡ç¥¨ä¼°å€¼ä¿¡æ¯</p>
            </div>

            <!-- åŠ è½½çŠ¶æ€ -->
            <div v-if="loading" class="flex justify-center items-center py-20">
                <div class="text-center">
                    <div class="loading-spinner mx-auto mb-4"></div>
                    <p class="text-gray-600">æ­£åœ¨åŠ è½½æ•°æ®...</p>
                </div>
            </div>

            <!-- é”™è¯¯çŠ¶æ€ -->
            <div v-if="error" class="bg-red-50 border border-red-200 rounded-lg p-6 mb-6">
                <div class="flex items-center">
                    <svg class="w-6 h-6 text-red-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-red-800 font-semibold">æ•°æ®åŠ è½½å¤±è´¥</h3>
                        <p class="text-red-600 mt-1">{{ error }}</p>
                    </div>
                </div>
                <button @click="queryData" class="mt-4 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition-colors">
                    é‡æ–°æŸ¥è¯¢
                </button>
            </div>

            <!-- æ•°æ®å±•ç¤ºåŒºåŸŸ -->
            <div v-if="!loading && !error && hasQueried && stockData.length > 0">
                <!-- æŸ¥è¯¢ç»“æœæ ‡é¢˜ -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ“Š æŸ¥è¯¢ç»“æœ</h3>
                            <p class="text-sm text-gray-600">
                                æŸ¥è¯¢æ—¥æœŸ: {{ selectedDate }} | 
                                è‚¡ç¥¨æ•°é‡: {{ stockData.length }} | 
                                ç­›é€‰æ¡ä»¶: {{ selectedStocks.length > 0 ? selectedStocks.join(', ') : 'å…¨éƒ¨è‚¡ç¥¨' }}
                            </p>
                        </div>
                        <button @click="exportData" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">
                            å¯¼å‡ºæ•°æ®
                        </button>
                    </div>
                </div>

                <!-- æ¦‚è§ˆå¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="metric-card rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">æ€»è‚¡ç¥¨æ•°é‡</p>
                                <p class="text-2xl font-bold text-gray-800">{{ stockData.length }}</p>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-full">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">ä¸­å›½10å¹´å›½å€º</p>
                                <p class="text-2xl font-bold text-gray-800">{{ formatNumber(averageChinaBondRate) }}%</p>
                            </div>
                            <div class="bg-yellow-100 p-3 rounded-full">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="metric-card rounded-xl p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-gray-600 text-sm">å¹³å‡1å¹´è‚¡æ¯ç‡</p>
                                <p class="text-2xl font-bold text-gray-800">{{ formatNumber(averageDividendRate) }}%</p>
                            </div>
                            <div class="bg-purple-100 p-3 rounded-full">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æœç´¢å’Œç­›é€‰ -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <input 
                                v-model="searchQuery" 
                                type="text" 
                                placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–åç§°..." 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                        </div>
                        <div class="flex gap-2">
                            <select v-model="sortBy" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="stock_code">è‚¡ç¥¨ä»£ç </option>
                                <option value="stock_price">è‚¡ä»·</option>
                                <option value="1_dividend">1å¹´è‚¡æ¯</option>
                                <option value="5_dividend">5å¹´å¹³å‡è‚¡æ¯</option>
                                <option value="5_business_rate">è¥æ”¶å¢é•¿ç‡</option>
                                <option value="5_profit_rate">åˆ©æ¶¦å¢é•¿ç‡</option>
                            </select>
                            <button 
                                @click="sortOrder = sortOrder === 'asc' ? 'desc' : 'asc'"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors"
                            >
                                {{ sortOrder === 'asc' ? 'â†‘' : 'â†“' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- è‚¡ç¥¨æ•°æ®è¡¨æ ¼ -->
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <h2 class="text-lg font-semibold text-gray-800">è‚¡ç¥¨ä¼°å€¼æ•°æ®</h2>
                        <p class="text-gray-600 text-sm mt-1">å…± {{ filteredStockData.length }} åªè‚¡ç¥¨</p>
                    </div>
                    
                    <!-- ç§»åŠ¨ç«¯å¡ç‰‡è§†å›¾ -->
                    <div class="md:hidden">
                        <div v-for="stock in paginatedData" :key="stock.id" class="border-b border-gray-100 p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h3 class="font-semibold text-gray-800">{{ stock.stock_code }}</h3>
                                    <p class="text-gray-600 text-sm">{{ stock.stock_name || 'æœªçŸ¥' }}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg" :class="getPriceColor(stock.stock_price)">
                                        Â¥{{ formatNumber(stock.stock_price) }}
                                    </p>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div>
                                    <span class="text-gray-500">1å¹´è‚¡æ¯:</span>
                                    <span class="ml-1 font-medium">{{ formatNumber(stock['1_dividend']) }}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">5å¹´è‚¡æ¯:</span>
                                    <span class="ml-1 font-medium">{{ formatNumber(stock['5_dividend']) }}%</span>
                                </div>
                                <div>
                                    <span class="text-gray-500">è¥æ”¶æ–œç‡:</span>
                                    <span class="ml-1 font-medium" :class="getGrowthColor(stock['5_business_rate'])">
                                        {{ formatNumber(stock['5_business_rate']) }}%
                                    </span>
                                    <span class="text-xs text-gray-400 ml-1">
                                        (RÂ²: {{ formatNumber(stock['5_business_rate_r2'], 3) }})
                                    </span>
                                </div>
                                <div>
                                    <span class="text-gray-500">åˆ©æ¶¦æ–œç‡:</span>
                                    <span class="ml-1 font-medium" :class="getGrowthColor(stock['5_profit_rate'])">
                                        {{ formatNumber(stock['5_profit_rate']) }}%
                                    </span>
                                    <span class="text-xs text-gray-400 ml-1">
                                        (RÂ²: {{ formatNumber(stock['5_profit_rate_r2'], 3) }})
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <div class="flex justify-between text-xs text-gray-500">
                                    <span>è®°å½•æ—¥æœŸ: {{ formatDateDisplay(stock.record_date) }}</span>
                                    <span>å›½å€ºåˆ©ç‡: {{ formatNumber(stock.c10_dept_rate) }}%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¡Œé¢ç«¯è¡¨æ ¼è§†å›¾ -->
                    <div class="hidden md:block overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è‚¡ç¥¨ä¿¡æ¯</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å½“å‰è‚¡ä»·</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è‚¡æ¯æ•°æ®</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å¢é•¿æ–œç‡ & RÂ²</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å›½å€ºåˆ©ç‡</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">è®°å½•æ—¥æœŸ</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="stock in paginatedData" :key="stock.id" class="hover:bg-gray-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div>
                                            <div class="text-sm font-medium text-gray-900">{{ stock.stock_code }}</div>
                                            <div class="text-sm text-gray-500">{{ stock.stock_name || 'æœªçŸ¥' }}</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-bold" :class="getPriceColor(stock.stock_price)">
                                            Â¥{{ formatNumber(stock.stock_price) }}
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <div>1å¹´: {{ formatNumber(stock['1_dividend']) }}%</div>
                                            <div>5å¹´: {{ formatNumber(stock['5_dividend']) }}%</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm">
                                            <div :class="getGrowthColor(stock['5_business_rate'])">
                                                è¥æ”¶: {{ formatNumber(stock['5_business_rate']) }}%
                                                <span class="text-xs text-gray-400 ml-2">
                                                    RÂ²: {{ formatNumber(stock['5_business_rate_r2'], 3) }}
                                                </span>
                                            </div>
                                            <div :class="getGrowthColor(stock['5_profit_rate'])">
                                                åˆ©æ¶¦: {{ formatNumber(stock['5_profit_rate']) }}%
                                                <span class="text-xs text-gray-400 ml-2">
                                                    RÂ²: {{ formatNumber(stock['5_profit_rate_r2'], 3) }}
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <div>ä¸­å›½: {{ formatNumber(stock.c10_dept_rate) }}%</div>
                                            <div>ç¾å›½: {{ formatNumber(stock.u10_dept_rate) }}%</div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        {{ formatDateDisplay(stock.record_date) }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            æ˜¾ç¤º {{ (currentPage - 1) * pageSize + 1 }} åˆ° {{ Math.min(currentPage * pageSize, filteredStockData.length) }} æ¡ï¼Œå…± {{ filteredStockData.length }} æ¡
                        </div>
                        <div class="flex space-x-2">
                            <button 
                                @click="currentPage--" 
                                :disabled="currentPage === 1"
                                class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                            >
                                ä¸Šä¸€é¡µ
                            </button>
                            <span class="px-3 py-1 text-sm text-gray-700">
                                {{ currentPage }} / {{ totalPages }}
                            </span>
                            <button 
                                @click="currentPage++" 
                                :disabled="currentPage === totalPages"
                                class="px-3 py-1 border border-gray-300 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                            >
                                ä¸‹ä¸€é¡µ
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ— æŸ¥è¯¢ç»“æœçŠ¶æ€ -->
            <div v-if="!loading && !error && hasQueried && stockData.length === 0" class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 mb-6 text-center">
                <svg class="w-12 h-12 text-yellow-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0118 12M6 20.291A7.962 7.962 0 016 12m6 8a8 8 0 100-16 8 8 0 000 16z"></path>
                </svg>
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">æœªæ‰¾åˆ°æ•°æ®</h3>
                <p class="text-yellow-600 mb-4">
                    åœ¨ {{ selectedDate }} æ²¡æœ‰æ‰¾åˆ°
                    {{ selectedStocks.length > 0 ? 'æ‰€é€‰è‚¡ç¥¨' : 'ä»»ä½•è‚¡ç¥¨' }}
                    çš„ä¼°å€¼æ•°æ®
                </p>
                <button @click="clearFilters" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors">
                    æ¸…é™¤ç­›é€‰æ¡ä»¶
                </button>
            </div>
        </main>

        <!-- åº•éƒ¨ä¿¡æ¯ -->
        <footer class="bg-white border-t border-gray-200 mt-12">
            <div class="container mx-auto px-4 py-6">
                <div class="text-center text-gray-600 text-sm">
                    <p>è‚¡ç¥¨è‚¡æ¯æŸ¥è¯¢ç³»ç»Ÿ Â© 2025 | æ•°æ®ä»…ä¾›å‚è€ƒï¼ŒæŠ•èµ„éœ€è°¨æ…</p>
                    <p class="mt-1">æœ€åæ›´æ–°: {{ lastUpdateTime }}</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        const { createApp } = Vue;
        const { createClient } = supabase;

        createApp({
            data() {
                return {
                    // Supabase é…ç½® - è¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…é…ç½®
                    supabaseUrl: 'https://cpwxatgwspryqgvpfyha.supabase.co',
                    supabaseKey: 'sb_publishable_ZGiUYYiUTtlfLMItnnUeuQ_igdQNNvW',
                    supabaseClient: null,
                    
                    // æŸ¥è¯¢æ¡ä»¶
                    selectedDate: '',
                    selectedStocks: [],
                    availableStocks: [],
                    hasQueried: false,
                    querying: false,
                    
                    // æ•°æ®çŠ¶æ€
                    stockData: [],
                    loading: false,
                    error: null,
                    lastUpdateTime: '',
                    
                    // æœç´¢å’Œç­›é€‰
                    searchQuery: '',
                    sortBy: 'stock_code',
                    sortOrder: 'asc',
                    
                    // åˆ†é¡µ
                    currentPage: 1,
                    pageSize: 20,
                    
                    // å¿«æ·æ—¥æœŸé€‰æ‹©
                    quickDates: [],
                    maxDate: ''
                }
            },
            
            computed: {
                filteredStockData() {
                    let filtered = this.stockData;
                    
                    // æœç´¢è¿‡æ»¤
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(stock => 
                            stock.stock_code?.toLowerCase().includes(query) ||
                            stock.stock_name?.toLowerCase().includes(query)
                        );
                    }
                    
                    // æ’åº
                    filtered.sort((a, b) => {
                        const aVal = a[this.sortBy] || 0;
                        const bVal = b[this.sortBy] || 0;
                        
                        if (this.sortOrder === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                    
                    return filtered;
                },
                
                paginatedData() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredStockData.slice(start, end);
                },
                
                totalPages() {
                    return Math.ceil(this.filteredStockData.length / this.pageSize);
                },
                
                
                averageChinaBondRate() {
                    const rates = this.stockData.filter(s => s.c10_dept_rate && !isNaN(s.c10_dept_rate)).map(s => s.c10_dept_rate);
                    return rates.length > 0 ? rates.reduce((a, b) => a + b, 0) / rates.length : 0;
                },
                
                averageDividendRate() {
                    // 1_dividend å­—æ®µæœ¬èº«å°±æ˜¯è‚¡æ¯ç‡æ•°æ®ï¼Œç›´æ¥è®¡ç®—å¹³å‡å€¼
                    const dividends = this.stockData.filter(s => s['1_dividend'] && !isNaN(s['1_dividend'])).map(s => s['1_dividend']);
                    return dividends.length > 0 ? dividends.reduce((a, b) => a + b, 0) / dividends.length : 0;
                }
            },
            
            methods: {
                async initSupabase() {
                    console.log('ğŸ”§ åˆå§‹åŒ– Supabase è¿æ¥...');
                    console.log('URL:', this.supabaseUrl);
                    console.log('Key:', this.supabaseKey ? 'å·²é…ç½®' : 'æœªé…ç½®');
                    
                    // æ£€æŸ¥æ˜¯å¦é…ç½®äº†çœŸå®çš„ Supabase ä¿¡æ¯
                    if (this.supabaseUrl === 'YOUR_SUPABASE_URL' || !this.supabaseUrl || !this.supabaseKey) {
                        console.log('âš ï¸ æœªé…ç½® Supabaseï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®');
                        this.initMockEnvironment();
                        return;
                    }
                    
                    try {
                        console.log('ğŸš€ åˆ›å»º Supabase å®¢æˆ·ç«¯...');
                        this.supabaseClient = createClient(this.supabaseUrl, this.supabaseKey);
                        
                        console.log('ğŸ“‹ åŠ è½½å¯ç”¨è‚¡ç¥¨åˆ—è¡¨...');
                        await this.loadAvailableStocks();
                        
                        console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ');
                    } catch (err) {
                        console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', err);
                        console.log('ğŸ”„ å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼');
                        this.initMockEnvironment();
                    }
                },

                // åˆå§‹åŒ–æ¨¡æ‹Ÿç¯å¢ƒ
                initMockEnvironment() {
                    console.log('ğŸ§ª åˆå§‹åŒ–æ¨¡æ‹Ÿæ•°æ®ç¯å¢ƒ');
                    this.availableStocks = [
                        { code: '000001', name: 'å¹³å®‰é“¶è¡Œ' },
                        { code: '600519', name: 'è´µå·èŒ…å°' }
                    ];
                    this.initQuickDates();
                },

                // åŠ è½½å¯ç”¨è‚¡ç¥¨åˆ—è¡¨
                async loadAvailableStocks() {
                    try {
                        if (!this.supabaseClient) {
                            throw new Error('Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
                        }
                        
                        console.log('ğŸ” æŸ¥è¯¢è‚¡ç¥¨åˆ—è¡¨...');
                        
                        let data, error;
                        
                        // æ ¹æ®æµ‹è¯•ç»“æœï¼Œç›´æ¥ä½¿ç”¨ dividend schema
                        console.log('ğŸ” ä½¿ç”¨ dividend schema æŸ¥è¯¢...');
                        const result = await this.supabaseClient
                            .schema('dividend')
                            .from('dividend_multi_factor')
                            .select('stock_code, stock_name')
                            .order('stock_code');
                        
                        data = result.data;
                        error = result.error;
                        
                        if (error) {
                            console.error('âŒ æŸ¥è¯¢è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                            throw error;
                        }
                        
                        console.log('ğŸ“Š è·å–åˆ°è‚¡ç¥¨æ•°æ®:', data?.length || 0, 'æ¡è®°å½•');
                        
                        if (!data || data.length === 0) {
                            console.log('âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰è‚¡ç¥¨æ•°æ®');
                            throw new Error('æ•°æ®åº“ä¸­æ²¡æœ‰è‚¡ç¥¨æ•°æ®');
                        }
                        
                        // å»é‡å¹¶æ ¼å¼åŒ–è‚¡ç¥¨åˆ—è¡¨
                        const uniqueStocks = [];
                        const seen = new Set();
                        
                        data.forEach(item => {
                            if (!seen.has(item.stock_code)) {
                                seen.add(item.stock_code);
                                uniqueStocks.push({
                                    code: item.stock_code,
                                    name: item.stock_name || 'æœªçŸ¥'
                                });
                            }
                        });
                        
                        this.availableStocks = uniqueStocks;
                        console.log('âœ… æˆåŠŸåŠ è½½', uniqueStocks.length, 'åªè‚¡ç¥¨');
                        
                        // åˆå§‹åŒ–å¿«æ·æ—¥æœŸ
                        this.initQuickDates();
                        
                    } catch (err) {
                        console.error('âŒ åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', err);
                        console.log('ğŸ”„ å›é€€åˆ°æ¨¡æ‹Ÿæ•°æ®æ¨¡å¼');
                        this.initMockEnvironment();
                    }
                },

                // åˆå§‹åŒ–å¿«æ·æ—¥æœŸ
                initQuickDates() {
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(today.getDate() - 1);
                    
                    const lastWeek = new Date(today);
                    lastWeek.setDate(today.getDate() - 7);
                    
                    const lastMonth = new Date(today);
                    lastMonth.setMonth(today.getMonth() - 1);
                    
                    this.quickDates = [
                        { label: 'ä»Šå¤©', date: this.formatDate(today) },
                        { label: 'æ˜¨å¤©', date: this.formatDate(yesterday) },
                        { label: 'ä¸€å‘¨å‰', date: this.formatDate(lastWeek) },
                        { label: 'ä¸€æœˆå‰', date: this.formatDate(lastMonth) }
                    ];
                    
                    this.maxDate = this.formatDate(today);
                    
                    // é»˜è®¤é€‰æ‹©æ˜¨å¤©çš„æ—¥æœŸ
                    this.selectedDate = this.formatDate(yesterday);
                },

                // é€‰æ‹©å¿«æ·æ—¥æœŸ
                selectQuickDate(date) {
                    this.selectedDate = date;
                },

                // æŸ¥è¯¢æ•°æ®
                async queryData() {
                    if (!this.selectedDate) {
                        alert('è¯·å…ˆé€‰æ‹©æŸ¥è¯¢æ—¥æœŸ');
                        return;
                    }
                    
                    this.querying = true;
                    this.loading = true;
                    this.error = null;
                    this.stockData = [];
                    
                    try {
                        if (this.supabaseClient) {
                            await this.fetchDataFromSupabase();
                        } else {
                            await this.fetchMockData();
                        }
                        
                        this.hasQueried = true;
                        this.lastUpdateTime = new Date().toLocaleString('zh-CN');
                        
                    } catch (err) {
                        console.error('æŸ¥è¯¢æ•°æ®å¤±è´¥:', err);
                        this.error = err.message || 'æŸ¥è¯¢å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                    } finally {
                        this.querying = false;
                        this.loading = false;
                    }
                },

                // ä» Supabase è·å–æ•°æ®
                async fetchDataFromSupabase() {
                    console.log('ğŸ” å¼€å§‹æŸ¥è¯¢ Supabase æ•°æ®...');
                    console.log('æŸ¥è¯¢æ—¥æœŸ:', this.selectedDate);
                    console.log('é€‰æ‹©çš„è‚¡ç¥¨:', this.selectedStocks);
                    
                    // ä½¿ç”¨æ­£ç¡®çš„ dividend schema è¿›è¡Œæ•°æ®æŸ¥è¯¢
                    let query = this.supabaseClient
                        .schema('dividend')
                        .from('dividend_multi_factor')
                        .select('*')
                        .eq('record_date', this.selectedDate);
                    
                    // å¦‚æœé€‰æ‹©äº†ç‰¹å®šè‚¡ç¥¨ï¼Œæ·»åŠ ç­›é€‰æ¡ä»¶
                    if (this.selectedStocks.length > 0 && !this.selectedStocks.includes('')) {
                        console.log('ğŸ¯ æ·»åŠ è‚¡ç¥¨ç­›é€‰æ¡ä»¶:', this.selectedStocks);
                        query = query.in('stock_code', this.selectedStocks);
                    }
                    
                    const { data, error } = await query.order('stock_code');
                    
                    if (error) {
                        console.error('âŒ Supabase æŸ¥è¯¢å¤±è´¥:', error);
                        throw error;
                    }
                    
                    console.log('ğŸ“Š æŸ¥è¯¢ç»“æœ:', data?.length || 0, 'æ¡è®°å½•');
                    console.log('æ•°æ®è¯¦æƒ…:', data);
                    
                    this.stockData = data || [];
                },

                // è·å–æ¨¡æ‹Ÿæ•°æ®
                async fetchMockData() {
                    // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // æ¨¡æ‹Ÿæ•°æ®ï¼Œæ ¹æ®é€‰æ‹©çš„æ—¥æœŸå’Œè‚¡ç¥¨è¿›è¡Œç­›é€‰
                    const allMockData = [
                        {
                            id: 1,
                            record_date: this.selectedDate,
                            stock_code: '000001',
                            stock_name: 'å¹³å®‰é“¶è¡Œ',
                            c10_dept_rate: 2.65,
                            u10_dept_rate: 4.2,
                            '1_dividend': 0.85,
                            '5_dividend': 0.78,
                            '5_business_rate': 8.5,
                            '5_business_rate_r2': 0.851,
                            '5_profit_rate': 12.3,
                            '5_profit_rate_r2': 0.782,
                            stock_price: 12.45,
                            created_at: new Date().toISOString()
                        },
                        {
                            id: 4,
                            record_date: this.selectedDate,
                            stock_code: '600519',
                            stock_name: 'è´µå·èŒ…å°',
                            c10_dept_rate: 2.65,
                            u10_dept_rate: 4.2,
                            '1_dividend': 23.88,
                            '5_dividend': 20.45,
                            '5_business_rate': 18.5,
                            '5_business_rate_r2': 0.923,
                            '5_profit_rate': 22.3,
                            '5_profit_rate_r2': 0.891,
                            stock_price: 1678.50,
                            created_at: new Date().toISOString()
                        }
                    ];
                    
                    // æ ¹æ®é€‰æ‹©çš„è‚¡ç¥¨è¿›è¡Œç­›é€‰
                    let filteredData = allMockData;
                    if (this.selectedStocks.length > 0 && !this.selectedStocks.includes('')) {
                        filteredData = allMockData.filter(stock => 
                            this.selectedStocks.includes(stock.stock_code)
                        );
                    }
                    
                    this.stockData = filteredData;
                },

                // æ¸…é™¤ç­›é€‰æ¡ä»¶
                clearFilters() {
                    this.selectedStocks = [];
                    this.searchQuery = '';
                },

                // å¯¼å‡ºæ•°æ®
                exportData() {
                    if (this.stockData.length === 0) {
                        alert('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º');
                        return;
                    }
                    
                    // åˆ›å»ºCSVå†…å®¹
                    const headers = ['è‚¡ç¥¨ä»£ç ', 'è‚¡ç¥¨åç§°', 'è‚¡ä»·', '1å¹´è‚¡æ¯ç‡(%)', '5å¹´è‚¡æ¯ç‡(%)', 'è¥æ”¶å¢é•¿æ–œç‡(%)', 'è¥æ”¶æ–œç‡RÂ²', 'åˆ©æ¶¦å¢é•¿æ–œç‡(%)', 'åˆ©æ¶¦æ–œç‡RÂ²', 'ä¸­å›½å›½å€ºåˆ©ç‡(%)', 'ç¾å›½å›½å€ºåˆ©ç‡(%)'];
                    const csvContent = [
                        headers.join(','),
                        ...this.stockData.map(stock => [
                            stock.stock_code,
                            stock.stock_name || '',
                            this.formatNumber(stock.stock_price),
                            this.formatNumber(stock['1_dividend']),
                            this.formatNumber(stock['5_dividend']),
                            this.formatNumber(stock['5_business_rate']),
                            this.formatNumber(stock['5_business_rate_r2'], 3),
                            this.formatNumber(stock['5_profit_rate']),
                            this.formatNumber(stock['5_profit_rate_r2'], 3),
                            this.formatNumber(stock.c10_dept_rate),
                            this.formatNumber(stock.u10_dept_rate)
                        ].join(','))
                    ].join('\n');
                    
                    // ä¸‹è½½æ–‡ä»¶
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `è‚¡ç¥¨ä¼°å€¼æ•°æ®_${this.selectedDate}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },

                // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD æ ¼å¼
                formatDate(date) {
                    return date.toISOString().split('T')[0];
                },

                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
                formatDateDisplay(dateString) {
                    if (!dateString) return 'N/A';
                    return new Date(dateString).toLocaleDateString('zh-CN');
                },

                // å®‰å…¨çš„æ•°å€¼æ ¼å¼åŒ–æ–¹æ³•
                formatNumber(value, decimals = 2) {
                    if (value === null || value === undefined || value === '' || isNaN(value)) {
                        return 'N/A';
                    }
                    const num = parseFloat(value);
                    if (isNaN(num)) {
                        return 'N/A';
                    }
                    return num.toFixed(decimals);
                },
                
                getPriceColor(price) {
                    if (!price) return 'text-gray-500';
                    return price > 50 ? 'text-red-600' : price > 20 ? 'text-yellow-600' : 'text-green-600';
                },
                
                getGrowthColor(rate) {
                    if (!rate) return 'text-gray-500';
                    return rate > 10 ? 'text-green-600' : rate > 0 ? 'text-yellow-600' : 'text-red-600';
                }
            },
            
            watch: {
                searchQuery() {
                    this.currentPage = 1;
                },
                
                sortBy() {
                    this.currentPage = 1;
                },
                
                sortOrder() {
                    this.currentPage = 1;
                }
            },
            
            async mounted() {
                await this.initSupabase();
            }
        }).mount('#app');
    </script>
</body>
</html>
